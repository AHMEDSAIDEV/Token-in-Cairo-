[id="kakarot"]

= Kakarot

A https://www.vmware.com/topics/glossary/content/virtual-machine.html[Virtual Machine (VM)] is a compute resource that uses software instead of a physical computer to run programs and deploy apps. One or more virtual “guest” machines run on a physical “host” machine.  Each virtual machine runs its own operating system and functions separately from the other VMs, even when they are all running on the same host. 

This means that, for example, a virtual MacOS virtual machine can run on a physical PC. 

Virtual machine technology is used for many use cases across on-premises and cloud environments. More recently, public cloud services are using virtual machines to provide varied computer architectures as well as application resources to multiple users at once, for even more cost efficient and flexible compute.  

== zkEVM

A zkEVM is a virtual machine that can execute the same high level programming language or low level bytecode as the Ethereum execution client, i.e the EVM. Further, a zkEVM can prove that it executed this Ethereum code correctly to the Ethereum blockchain by leveraging validity proofs. 

The main reason for using zkEVMs is quite similar to the reason for using any other rollup. It allows users to submit transactions to a large and powerful validator which then makes a proof of their validity, compresses them and sends them as a “digest” to Ethereum. This way, more transactions can be included in a single Ethereum block for lower gas costs, and often at faster speeds. 

The main advantage of using a zkEVM is its ability to work with all the code and infrastructure already deployed on Ethereum - the de facto programmable blockchain - without introducing a new learning curve for most developers. 

At the same time, the EVM was never designed to be ZK provable and hence zkEVMs have to deal with massive computational overhead which can make them less efficient at executing programs than Ethereum, or even other rollups like Starknet. 

It should suffice to say, making efficient zkEVMs is an ambitious and long term plan to scale the Ethereum blockchain. 

== Kakarot

https://www.kakarot.org/[Kakarot zkEVM] is an implementation of the Ethereum Virtual Machine (Ethereum’s execution client) written in Cairo. Because of this, all the Solidity bytecode that is run on Kakarot can also simultaneously be proven for executional correctness to the Ethereum network itself. 

Kakarot zkEVM enables teams to build & deploy EVM apps. Developers can deploy any Solidity (or EVM code) on Kakarot, as they would on Ethereum or Polygon. Their end-users are then able to interact with dApps with their usual toolchain (Metamask, Wallet connect) and so on.

image:kakarot_diagram.png[kakarot_diagram]

== Data Availability

zkEVMs, just like all other rollup solutions, must make an engineering decision regarding the storage of the state data they process. This way, users can reconstruct the state on Ethereum if the rollup becomes malicious or stops functioning. Hence, many developers argue that an Ethereum rollup can only consider itself trustless if it writes all of this state data on Ethereum. 

At the same time, writing data on Ethereum is extremely expensive. This has opened up the debate for various methods of data availability. As of now, there are 2 leading solutions - 

=== Validium:

The rollup writes all state data off-chain. This means all the state updates caused by smart contracts are stored externally in an accessible source such as https://docs.starkware.co/starkex/con_data_availability.html[Data Availability Committee (DAC)]. 

Doing so allows the rollup to improve throughput by processing transactions off the Ethereum Mainnet.

=== Volition:
 
Users have a choice to make data available to Ethereum (for better security at a higher cost). Or, they can store the data off chain with a trusted, albeit centralized committee. 
	
In the future, Starknet L2 might serve solely as a proof verification layer for Kakarot. At the same time, new data availability solutions, such as Celestia or EigenDA, might be utilized for posting transaction data. Users will have the choice to opt-in to either option, depending on their security requirements.

== EVM Equivalence

So far, we have learned that a zkEVM is a special type of ZK rollup which mimics the execution environment of mainnet Ethereum. There are 3 main types of zkEVMs based on how closely they mimic Ethereum - 

=== Language Equivalent 

These types of zkEVMs can translate EVM bytecode into a custom built language optimized for generating ZK proofs - eg. Cairo. This is considered to be the easiest and most efficient way to achieve EVM compatibility with rollups. Moreover, this was the original approach taken by Netheremind through the much celebrated transpiler https://github.com/NethermindEth/warp[Warp]. 

However, sophisticated developer tooling, frameworks, security practices and testing environments built for the EVM may not translate so well to language equivalent zkEVMs.

=== Bytecode Equivalent 

A bytecode equivalent VM can interpret EVM bytecode just like the Ethereum execution client, and hence achieve a deeper level of compatibility with Ethereum. This is done by implementing the various EVM opcodes into the zkEVM’s computer architecture. 

However, because the EVM was not designed with ZK friendliness in mind - this often comes with the massive downside of creating an extremely inefficient machine that is expensive to run.

This is where the https://github.com/kkrt-labs/kakarot[Kakarot repository] stands currently. It is able to execute all the existing opcodes from Ethereum - regardless of how cheap or expensive it is to do so. It also charges users accordingly, i.e, it is more expensive to execute less ZK friendly opcodes and so on. 

=== Consensus Equivalent 

This is the highest level of compatibility with the EVM that a blockchain can accomplish. Consensus equivalent zkEVMs are also sometimes called enshrined VMs. The idea is that cryptographic proofs executed by a zkEVM do not need to be re-executed on Ethereum in any capacity. 

The proofs themselves can be used to validate blocks produced on Ethereum mainnet. Such zkEVMs do not change any part of the Ethereum system to make it easier to generate proofs, and are hence able to benefit from the existing Ethereum infrastructure as much as possible. 

No consensus equivalent zkEVM exists today. However, this is a field of active research for the Kakarot team. 

== Kakachin L3 zkEVM 

Kakarot and Madara can be combined into a unified tech stack to fully accomplish Starknet’s vision for fractal scaling. This is part of Starknet’s mission to support the rollup-centric roadmap for Ethereum.

A Madara full node can be configured to work with the Kakarot zkEVM runtime environment, as opposed to vanilla Cairo VM. Ethereum’s consensus rules can also be implemented in Cairo and enshrined in this Kakarot x Madara full node. This is also called Kakachin. 

To make Kakachine a consensus equivalent system, they would have to -

- Write the Ethereum consensus rules in Cairo inside the Madara x Kakarot full node, thus enabling the proving of L1 consensus.
- Switch from Pedersen Merkle Patricia Trie (MPT) to Keccak MPT in the VM architecture.

Then, Kakachin would become a type 1 zkEVM client, able to prove L1 blocks. This is a more advanced use-case that depends on Ethereum’s roadmap, most notably the Verge. After the Verge, keccak might be replaced by poseidon as the hash function of choice for Ethereum. 

== Kakachin for Fractal Scaling

The Kakachin project creates a version of a normal Ethereum full node, which can run as a layer on top of Starknet Layer 2, or other Layer 3s implementing a similar architecture. This way, you could have multiple Layer 3, 4 or 5 zkEVMS writing to Starknet which then settles these state updates on Ethereum.

As a result, teams will be able to deploy their solidity code on zkEVM app-chains, and leverage validity proofs to settle transactions on Starknet. Gas costs will be exponentially lower than on L2 (and hence much lower than L1), and performance (TPS) will be higher. This is in addition to the scalability perks of Starknet and zkRollups in general.
